/** ###################################################################
**     THIS BEAN MODULE HAS BEEN GENERATED BY JEM.
**     Filename  : PWMs.C
**     Project   : _12_10
**     Processor : MC9S12A64BCFU
**     for Bean  : PPG
**     Version   : Bean 02.086, Driver 01.07, CPU db: 2.87.268
**     Compiler  : Metrowerks HC12 C Compiler
**     Date/Time : 17/10/2005, 10:53
**     Abstract  :
**         The bean "PPG" implements a programmable
**         pulse generator that generates signal with variable
**         duty and variable cycle (period).
**     Settings  :
**         Used output pin             : 
**             ----------------------------------------------------
**                Number (on package)  |    Name
**             ----------------------------------------------------
**                       3             |  PP1_PWM1_KWP1
**             ----------------------------------------------------
**
**         Timer name                  : PWM01 [16-bit] 
**         Counter                     : PWMCNT01  [172]
**         Mode register               : PWMCTL    [165]
**         Run register                : PWME      [160]
**         Prescaler                   : PWMPRCLK  [163]
**         Compare 1 register          : PWMPER01  [180]
**         Compare 2 register          : PWMDTY01  [188]
**         Flip-flop 1 register        : PWMPOL    [161]
**
**         Output pin
**
**         Port name                   : P
**         Bit number (in port)        : 1
**         Bit mask of the port        : 2
**         Port data register          : PTP       [600]
**         Port control register       : DDRP      [602]
**
**         Runtime setting period      : modes (list of settings)
**         Runtime setting ratio       : calculated
**         Initialization:
**              Aligned                : Left
**              Output level           : low
**              Timer                  : Disabled
**              Event                  : Enabled
**         High speed mode
**             Prescaler               : divide-by-1
**           Initial value of            period        pulse width (ratio 0.291%)
**             Xtal ticks              : 998816        2912
**             microseconds            : 249704        728
**             milliseconds            : 250           1
**             seconds (real)          : 0.2497040     0.0007280
**
** ###################################################################*/

#include "PWM.h"
#include "PWMs.h"
#define PWMDTY_ARRAY  ((word *) &PWMDTY0)			//pointer a reg del duty
#define PWMPER_ARRAY  ((word *) &PWMPER0)			//idem a reg del periodo

 extern word RatioStore[4];

//volatile word PWM_Period[4] @(0x000000B4);


/*
** ===================================================================
**     Method      :  SetRatio (bean PPG)
**
**     Description :
**         This method is internal. It is used by Processor Expert
**         only.
** ===================================================================
*/
void PWM_SetRatio(byte salida)
{
 if (salida<3)  
  PWMDTY_ARRAY[salida] = (word)((PWMPER_ARRAY[salida] * (dword)RatioStore[salida] + 500) / 1000); // Calculate new value of duty 
 else
  PWM_SetDuty(RatioStore[salida]); 
}

/*
** ===================================================================
**     Method      :  PWM01_SetRatio16 (bean PPG)
**
**     Description :
**         This method sets a new duty-cycle ratio.
**     Parameters  :
**         NAME       - DESCRIPTION
**         Ratio      - Ratio is expressed as an 16-bit unsigned integer
**                      number. 0 - 65535 value is proportional
**                      to ratio 0 - 100%
**         Note: Calculated duty depends on the timer possibilities
**               and on the selected period.
**     Returns     :
**         ---        - Error code
** ===================================================================
*/
void PWM_SetRatio16(word Ratio,byte salida)
{
  
    RatioStore[salida] = Ratio;                  /* Store new value of the ratio */
  
    PWM_SetRatio(salida);                          
/* Calculate and set up new appropriate values of 

the duty and period registers */
}



 /* PWM. 
El valor para control debe ser de 1000 niveles. El clock del micro es 25 mhz.
Con el primer divisor podemos dividir hasta 128 y con el 2o hasta 512.
Ademas podemos contar hasta 65000. Con clock fijo y 1000 cuentas minimo
tenemos rango 65:1.
Tomamos 60000 cuentas para 60 segundos precisamos un clock de 1ms, y llegamos 
a 1 segundo con 1000 cuentas.
Para 0.6 segundos con 60000 cuentas precisamos de 10 microsegundos.
La tabla queda asi:

periodo     clock     cuenta  

  50 s        1ms       50000
  20 s        1ms       20000
  10 s        1ms       10000
   5 s				1ms				 5000
	 2 s        1ms        2000
	 1 s        1ms        1000
	.5 s       10us       50000   
  .2 s       10us       20000
  .1 s       10us       10000
  anlg       10us        2000 cuentas que son 50 c/s
  
  y de esta forma abarcamos todo el rango sin cambiar de frecuencia ni divisor
  y podemos tener periodos diferentes en cada salida  */

  
    
 void setPWM_period(TPeriod Mode, byte salida)

{

static const unsigned int PER[10] = {
    20000,														//100ms
    40000,														//200ms
     1085,														//500ms
    2170,														//01s
    4340,														//02s
    10851,												    //05s
    21701,														//10s
    43403,														//20s
    65104,     												//30s
     2000															//10ms
  };

static const byte CLK[10] = {
    0,														 //100ms
    0,														 //200ms
    1,														 //500ms
    1,														 //01s
    1,														 //02s
    1,												     //05s
    1,														 //10s
    1,														 //20s
    1,     												 //30s
    0															 //10ms
  }; 
  
  switch (salida){
    case 0: PWMCLK_PCLK1=CLK[Mode];			              
            PWMDTY01 = PER[Mode]/2;
            PWMPER01 = PER[Mode];
    				break;
    case 1: PWMCLK_PCLK3=CLK[Mode];			              
            PWMDTY23 = PER[Mode]/2;
            PWMPER23 = PER[Mode];
            break;
    case 2: PWMCLK_PCLK5=CLK[Mode];			              
            PWMDTY45 = PER[Mode]/2;
            PWMPER45 = PER[Mode];
    				break;
    case 3: 		              
            PWM_SetPeriod(Mode); 
  }

  PWM_SetRatio(salida);
}



/*
** ===================================================================
**     Method      :  PWM01_Init (bean PPG)
**
**     Description :
**         This method is internal. It is used by Processor Expert
**         only.
** ===================================================================
*/
void PWM01_Init(void)
{
  PWME_PWME1 = 1;                      /*. Run counter */
  PWMPOL_PPOL1=1;									     /* .ok*/
  PWMCLK_PCLK1 = 1;                    /*. Select clock source */
  PWMPRCLK_PCKA = 7;                  
  PWMCAE_CAE1 = 0;
  PWMCTL_CON01 = 1;
  PWMCNT01 = 0;

  PWMSCLA = 45; 
  PWMDTY01 = 0;                    /* Store initial value to the duty-compare register */
  PWMPER01 = 10;                /* and to the period register */
  
}

/*
** ===================================================================
**     Method      :  PWM23_Init (bean PPG)
**
**     Description :
**         This method is internal. It is used by Processor Expert
**         only.
** ===================================================================
*/

void PWM23_Init(void)
{
  PWME_PWME3 = 0;							         /*. Run counter */
  PWMPOL_PPOL3 = 1;										 /*.ok*/
  PWMCLK_PCLK3=1;											 /*. Select clock source */
  PWMPRCLK_PCKB = 7;                  
  PWMCAE_CAE3 = 0;
  PWMCTL_CON23 = 1;
  PWMCNT23 = 0;

  PWMSCLB=0;
  PWMDTY23=0;
  PWMPER23 =10;
}

/*
** ===================================================================
**     Method      :  PWM45_Init (bean PPG)
**
**     Description :
**         This method is internal. It is used by Processor Expert
**         only.
** ===================================================================
*/

void PWM45_Init(void)
{
  PWME_PWME5 = 1;											  /*. Run counter */
  PWMPOL_PPOL5 = 1;										 /*.ok*/
  PWMCLK_PCLK5=0;			                  /*. Select clock source */
  PWMPRCLK_PCKA = 7;                  
  PWMCTL_CON45 = 1;
  PWMCNT45 = 0;

  PWMSCLA=45;
  PWMDTY45 = 0;
  PWMPER45 = 10;
}

